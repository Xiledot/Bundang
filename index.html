<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>영어 학습 도우미</title>
    <style>
        /* ... CSS 스타일 ... */
         body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f9f9f9; }
        h1, h2 { text-align: center; color: #333; }
        /* ... (이전에 제공된 CSS 스타일 전체 붙여넣기) ... */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js"></script>
</head>
<body>
    <h1>영어 학습 도우미</h1>
    <div id="navigation">
        <button id="show-structure-btn" class="active">구조 분석</button>
        <button id="show-question-btn">문제 생성</button>
    </div>
    <div id="structure-analysis-section" class="feature-section active">
        <h2>문장 구조 분석</h2>
        <textarea id="inputSentence" rows="4" placeholder="분석할 영어 문장을 입력하세요..."></textarea><br>
        <button id="analyze-btn">분석하기</button>
        <div id="outputArea" class="output">분석 결과가 여기에 표시됩니다.</div>
    </div>
    <div id="question-generation-section" class="feature-section">
        <h2>문제 생성</h2>
        <textarea id="inputTextForQuestions" rows="10" placeholder="문제 생성을 위한 영어 지문을 입력하세요..."></textarea><br>
        <div id="quantity-selector" style="margin-bottom: 10px;">
             <span>문제 개수 선택: </span>
             <button data-quantity="1" class="selected">1개</button>
             <button data-quantity="3">3개</button>
             <button data-quantity="5">5개</button>
        </div>
        <button id="generate-questions-btn">문제 생성하기</button>
        <div id="questionsOutputArea" class="output">생성된 문제가 여기에 표시됩니다.</div>
    </div>

    <script>
        // --- 공통 변수 및 함수 ---
        // ... (이전에 제공된 공통 변수 및 함수 정의 붙여넣기) ...
        const structureSection = document.getElementById('structure-analysis-section');
        const questionSection = document.getElementById('question-generation-section');
        // ... (나머지 변수들) ...
         let activeLines = [];


        // --- 구조 분석 관련 변수 및 함수 ---
        // ... (colorMap, adjectiveModifierRoles 등 변수 정의) ...
         const colorMap = { /* ... */ };
         const adjectiveModifierRoles = ["형용사", "형용사구", "형용사절"];


        // 구조 분석 실행 함수 (Netlify 경로 확인!)
        async function analyzeSentence() {
            const sentence = document.getElementById("inputSentence").value.trim();
            if (!sentence) { alert("분석할 문장을 입력하세요."); return; }
            outputArea.innerHTML = "분석 중..."; removeLines();
            try {
                // ★★★ Netlify 경로 확인 ★★★
                const response = await fetch("/.netlify/functions/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sentence })
                });
                // ... (응답 처리 및 오류 처리 로직, 이전에 제공된 상세 버전 사용) ...
                 if (!response.ok) {
                    let errorMsg = `HTTP 오류 ${response.status}: ${response.statusText}`;
                    try { const errData = await response.json(); errorMsg += `\n서버 메시지: ${errData.error || JSON.stringify(errData)}`; } catch (e) {}
                    console.error('구조 분석 요청 실패:', errorMsg);
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                 if (!Array.isArray(data)) {
                     console.error("받은 데이터가 배열 형태가 아님:", data);
                     throw new Error("서버로부터 유효하지 않은 형식의 응답을 받았습니다.");
                 }
                outputArea.innerHTML = data.map((sentenceData, idx) => renderAnalysisBlock(sentenceData, idx)).join('');
                setTimeout(() => { /* ... 화살표 그리기 ... */ }, 100);
            } catch (error) {
                console.error('구조 분석 중 오류 발생:', error);
                outputArea.innerHTML = `<p style="color: red;">오류 발생: ${error.message}</p>`;
            }
        }

        // --- 문제 생성 관련 함수 ---
        // ... (quantitySelector 이벤트 리스너) ...
         quantitySelector.addEventListener('click', (event) => { /* ... */ });

        // 문제 생성 실행 함수 (Netlify 경로 확인!)
        async function generateQuestions() {
            // ... (text, quantity 가져오는 로직) ...
             const text = document.getElementById('inputTextForQuestions').value.trim();
             const selectedButton = quantitySelector.querySelector('button.selected');
             const quantity = selectedButton ? parseInt(selectedButton.getAttribute('data-quantity'), 10) : 1;
             if (!text) { alert("지문을 입력하세요."); return; }
            questionsOutputArea.innerHTML = `<p>문제 ${quantity}개를 생성 중입니다...</p>`;
            try {
                // ★★★ Netlify 경로 확인 ★★★
                const response = await fetch("/.netlify/functions/api/generate-questions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: text, quantity: quantity })
                });
                // ... (응답 처리 및 오류 처리 로직, 이전에 제공된 상세 버전 사용) ...
                 if (!response.ok) {
                    let errorMsg = `HTTP 오류 ${response.status}: ${response.statusText}`;
                    try { const errData = await response.json(); errorMsg += `\n서버 메시지: ${errData.error || JSON.stringify(errData)}`; } catch (e) {}
                    console.error('문제 생성 요청 실패:', errorMsg);
                    throw new Error(errorMsg);
                }
                const dataArray = await response.json();
                 if (!Array.isArray(dataArray)) { throw new Error("..."); }
                 if (dataArray.length === 0) { /* ... */ return; }
                let finalOutput = ""; dataArray.forEach((data, index) => { /* ... HTML 생성 ... */ }); questionsOutputArea.innerHTML = finalOutput;
            } catch (error) {
                console.error('문제 생성 중 오류 발생:', error);
                questionsOutputArea.innerHTML = `<p style="color: red;">오류 발생: ${error.message}</p>`;
            }
        }

        // --- 함수 구현부 (setActiveSection, removeLines 등) ---
        // ... (이전에 제공된 함수 구현부 전체 붙여넣기) ...
        function setActiveSection(activeBtn, activeSection) { /* ... */ }
        function removeLines() { /* ... */ }
        function renderAnalysisBlock(sentenceData, idx) { /* ... */ }
        function drawModifyingArrows(sentenceData, blockId) { /* ... */ }
        function toggleAnswer(button) { /* ... */ }

        // --- 이벤트 리스너 연결 및 초기화 ---
        // ... (이전에 제공된 이벤트 리스너 연결 코드 붙여넣기) ...
         showStructureBtn.addEventListener('click', () => setActiveSection(showStructureBtn, structureSection));
        showQuestionBtn.addEventListener('click', () => setActiveSection(showQuestionBtn, questionSection));
        document.getElementById("analyze-btn").addEventListener("click", analyzeSentence);
        document.getElementById('generate-questions-btn').addEventListener("click", generateQuestions);
        setActiveSection(showStructureBtn, structureSection);

    </script>

</body>
</html>